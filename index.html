<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title> منصة التفوق</title>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;600;700;800&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
  <style>
    :root {
      --primary: #1877F2;
      --primary-dark: #166CDA;
      --primary-light: #3B90F5;
      --secondary: #2196f3;
      --accent: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --success: #8bc34a;

      --plyr-color-main: #1877F2;
      --bg-color: #0a0a0a;
      --bg-secondary: #121212;
      --text-color: #ffffff;
      --text-secondary: #b0b0b0;
      --card-color: #1e1e1e;
      --card-hover: #2a2a2a;
      --border-color: #333333;
      --shadow: 0 4px 20px rgba(0,0,0,0.3);
      --shadow-hover: 0 8px 30px rgba(24,119,242,0.2); 

      --gradient-primary: linear-gradient(135deg, #1877F2 0%, #3B90F5 100%);
      --gradient-card: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
      --gradient-bg: linear-gradient(180deg, #0a0a0a 0%, #121212 100%);
    }

    [data-theme="light"] {
      --primary: #1877F2;
      --primary-dark: #166CDA;
      --primary-light: #3B90F5;
      --bg-color: #f8f9fa;
      --bg-secondary: #ffffff;
      --text-color: #212529;
      --text-secondary: #6c757d;
      --card-color: #ffffff;
      --card-hover: #f8f9fa;
      --border-color: #e9ecef;
      --shadow: 0 4px 20px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 30px rgba(24,119,242,0.15); 

      --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      --gradient-bg: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Almarai', sans-serif;
    }

    body {
      background: var(--gradient-bg);
      color: var(--text-color);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Page transitions */
    .page {
      display: none;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .page.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    /* Header styles */
    header {
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .site-title {
      color: var(--primary);
      font-size: 2rem;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      text-shadow: 0 2px 4px rgba(24,119,242,0.3); 
      position: relative;
    }

    .site-title:hover {
      transform: scale(1.05);
      animation: pulse 2s infinite;
    }

    .site-title::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: var(--gradient-primary);
      border-radius: 8px;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s;
    }

    .site-title:hover::before {
      opacity: 0.1;
    }

    .nav-buttons {
      display: flex;
      gap: 1rem;
      margin: 0 1rem;
      background: var(--bg-secondary);
      padding: 0.5rem;
      border-radius: 12px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .nav-btn {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-primary);
      transition: left 0.3s;
      z-index: -1;
    }

    .nav-btn:hover {
      color: white;
      transform: translateY(-2px);
    }

    .nav-btn:hover::before {
      left: 0;
    }

    .nav-btn.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-hover);
    }

    .search-container {
      flex-grow: 1;
      max-width: 600px;
      display: flex;
      gap: 1rem;
      position: relative;
    }

    #searchInput {
      width: 100%;
      padding: 1rem 1.5rem;
      border: 2px solid var(--border-color);
      border-radius: 25px;
      background: var(--card-color);
      color: var(--text-color);
      font-size: 1rem;
      transition: all 0.3s;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    #searchInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24,119,242,0.1); 
      transform: translateY(-2px);
    }
    
    /* NEW STYLE FOR MODAL INPUTS */
    .modal-input {
        width: 100%;
        padding: 1rem 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        background: var(--card-color);
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem; /* Added margin for spacing */
        text-align: right; /* Ensure text is right-aligned in RTL context */
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(24,119,242,0.1); 
      transform: translateY(-2px);
    }


    #searchButton, #themeToggle {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    #searchButton {
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #themeToggle {
      padding: 1rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #searchButton:hover, #themeToggle:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    /* Card styles */
    .teachers-grid, .materials-grid, .exams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }

    .teacher-card, .material-card, .exam-card {
      background: var(--gradient-card);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .teacher-card:hover, .material-card:hover, .exam-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary);
    }

    .teacher-image {
      width: 100%;
      height: auto;
      border-radius: 10px;
      margin-bottom: 1rem;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .teacher-card:hover .teacher-image {
      transform: scale(1.03);
    }

    .teacher-card h3 {
      color: var(--primary-light);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .teacher-card p, .material-card p, .exam-card p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .material-card .download-btn, .exam-card .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      margin-top: 1rem;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
    }

    .material-card .download-btn:hover, .exam-card .download-btn:hover {
      background: #388e3c; /* Darker accent */
    }

    .loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-size: 1.2rem;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Classes Page Styles */
    .classes-page {
      display: flex;
      gap: 3rem;
      margin-top: 2rem;
    }

    .classes-list {
      flex: 1;
    }

    .class-item {
      background: var(--card-color);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border-right: 5px solid var(--primary-dark);
      box-shadow: var(--shadow);
      transition: all 0.3s;
    }

    .class-item:hover {
      background: var(--card-hover);
    }

    .class-item h4 {
      color: var(--primary-light);
      margin-bottom: 0.5rem;
      font-weight: 700;
      cursor: pointer;
    }

    .lectures-list {
      list-style: none;
      padding: 0.5rem 0;
      display: none;
    }

    .lecture-item {
      padding: 0.5rem 0;
      border-bottom: 1px dashed var(--border-color);
      cursor: pointer;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lecture-item:hover {
      color: var(--primary);
    }

    .lecture-item i {
      color: var(--primary);
    }

    .video-player-container {
      flex: 2;
      position: sticky;
      top: 110px; /* Adjust based on header height */
      max-height: 80vh;
    }

    .video-title {
      color: var(--primary);
      font-size: 1.5rem;
      margin-top: 0;
      margin-bottom: 1rem;
      font-weight: 700;
    }

    /* Video Player Styles */
    .plyr--video {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow-hover);
    }

    .back-button {
      background: var(--error);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      width: fit-content;
    }

    .back-button:hover {
      background: #c62828; /* Darker error */
      transform: translateY(-2px);
    }

    /* Other Styles */
    .section-title {
      color: var(--primary);
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 1rem;
      border-right: 5px solid var(--primary);
      padding-right: 15px;
    }

    .student-counter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-color);
      background: var(--card-hover);
      padding: 0.5rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      border: 1px solid var(--primary);
      animation: pulse 2s infinite;
    }

    .student-counter i {
      color: var(--primary);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--card-color);
      padding: 2.5rem;
      border-radius: 15px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
    }

    .modal-content h3 {
      margin-bottom: 1rem;
      color: var(--primary);
      font-weight: 700;
    }

    /* Removed original styles for accessCodeInput and button to use the new modal-input class */
    .modal-content input[type="text"], .modal-content input[type="tel"] {
        /* This will be handled by .modal-input now */
    }

    .modal-content button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 1rem 2rem;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
      width: 100%;
    }

    .modal-content button:hover {
      background: var(--primary-dark);
    }

    .error-message {
      color: var(--error);
      margin-top: 1rem;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .close-btn {
      background: transparent !important;
      color: var(--text-secondary);
      width: auto !important;
      padding: 0.5rem !important;
      transition: color 0.3s !important;
    }

    .close-btn:hover {
      color: var(--error) !important;
      background: transparent !important;
    }

    /* Contact Button */
    #floatingContactBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      z-index: 50;
    }

    #floatingContactBtn:hover {
      background: #689f38; /* Darker success */
      transform: scale(1.1);
      box-shadow: 0 8px 30px rgba(139, 195, 74, 0.4); 
    }

    /* Selection Modal (Trial/Paid) */
    #selectionModal .modal-content {
      max-width: 600px;
    }

    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .selection-option {
      background: var(--card-hover);
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      border: 2px solid var(--border-color);
      transition: all 0.3s;
    }

    .selection-option:hover {
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(24, 119, 242, 0.3);
      transform: translateY(-3px);
    }

    .selection-option i {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .selection-option.paid i { color: var(--primary); }
    .selection-option.trial i { color: var(--success); }
    .selection-option h4 { margin: 0; }

    /* Upgrade Modal */
    #upgradeModal .modal-content {
      border: 3px solid var(--warning);
    }
    #upgradeModal h3 {
      color: var(--warning);
    }

    /* Media Queries */
    @media (max-width: 1200px) {
      header {
        gap: 1rem;
      }
      .search-container {
        flex-basis: 100%;
        order: 3;
      }
      .nav-buttons {
        order: 2;
        margin: 0;
      }
      #themeToggle {
        order: 4;
      }
      .classes-page {
        flex-direction: column;
      }
      .video-player-container {
        position: relative;
        top: 0;
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }
      .site-title {
        font-size: 1.5rem;
      }
      .nav-buttons {
        flex-wrap: wrap;
        width: 100%;
        padding: 0;
        background: transparent;
        box-shadow: none;
      }
      .nav-btn {
        flex-grow: 1;
        text-align: center;
        margin-bottom: 0.5rem;
      }
      .page {
        padding: 1rem;
      }
      .teacher-card, .material-card, .exam-card {
        padding: 1.5rem;
      }
      #floatingContactBtn {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        bottom: 15px;
        right: 15px;
      }
      .selection-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .site-title { 
        font-size: 1.2rem; 
      }
      .nav-btn { 
        padding: 0.5rem 0.8rem; 
        font-size: 0.8rem; 
      }
      #searchInput {
        padding: 0.8rem 1rem;
      }
      .teacher-card, .material-card, .exam-card {
        padding: 1.5rem;
      }
      .section-title { 
        font-size: 1.5rem; 
      }
    }
  </style>
 </head>
 <body>
  
  <div id="selectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <i class="fas fa-gavel" style="font-size: 3rem; color: var(--error); margin-bottom: 1rem;"></i>
        <h3>مرحباً بك في منصة التفوق للاستاذ: حيدر علي الطائي</h3>
        <div style="text-align: center; background: var(--card-hover); padding: 1.5rem; border-radius: 10px; border: 2px solid var(--error); margin-bottom: 1.5rem;">
          <h4 style="color: var(--primary); margin-bottom: 0.5rem;">الأستاذ: حيدر علي الطائي (Hayder Ali Al-Taie)</h4>
          <p style="color: var(--text-secondary);">مدرس مادة اللغة الإنجليزية</p>
        </div>
        
        <h3 style="color: var(--text-color); margin-top: 0.5rem;">اختر طريقة الدخول:</h3>
        <div class="selection-grid">
            <div class="selection-option paid" onclick="openLoginModal()">
                <i class="fas fa-key"></i>
                <h4>الدخول بكود (مدفوع)</h4>
                <p style="margin-top: 0.5rem;">للوصول لكافة المحاضرات والملازم والامتحانات.</p>
            </div>
            <div class="selection-option trial" onclick="handleTrialLogin()">
                <i class="fas fa-hand-sparkles"></i>
                <h4>الدخول التجريبي (مجاني)</h4>
                <p style="margin-top: 0.5rem;">للوصول للوحدة الأولى فقط (5 محاضرات مجانية).</p>
            </div>
        </div>

    </div>
  </div>


  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
        <i class="fas fa-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
        <h3>أدخل بيانات الدخول والتعهد</h3>

        <input type="text" id="studentNameInput" class="modal-input" placeholder="الاسم الكامل للطالب" required>
        <input type="tel" id="studentPhoneInput" class="modal-input" placeholder="رقم الهاتف (للتواصل)" required>

        <input type="text" id="accessCodeInput" class="modal-input" placeholder="أدخل كود الدخول هنا" required>

        <div style="display: flex; align-items: flex-start; margin-top: 0.5rem; margin-bottom: 1.5rem; width: 100%; text-align: right; direction: rtl;">
            <input type="checkbox" id="acknowledgmentCheckbox" required style="width: auto; margin-left: 10px; margin-right: 0; transform: scale(1.3); flex-shrink: 0; border: 2px solid var(--border-color); accent-color: var(--primary);">
            <label for="acknowledgmentCheckbox" style="font-size: 0.9rem; color: var(--text-secondary); cursor: pointer;">
                أتعهد بالالتزام بشروط الاستخدام وعدم مشاركة الكود مع أي شخص آخر.
            </label>
        </div>

        <button onclick="handleLogin()" id="loginButton">تسجيل الدخول</button>
        <p id="loginError" class="error-message" style="display: none;"></p>
        <button onclick="closeModal('loginModal')" class="close-btn" style="position: absolute; top: 15px; right: 15px;">
            <i class="fas fa-times"></i>
        </button>
    </div>
  </div>

  <div id="upgradeModal" class="modal" style="display: none;">
      <div class="modal-content">
          <i class="fas fa-crown" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
          <h3>محتوى مخصص للمشتركين المدفوعين</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">هذا القسم (الملازم/الامتحانات) متاح فقط للمستخدمين الذين قاموا بتفعيل كود الدخول المدفوع.</p>
          <button onclick="closeModal('upgradeModal')">إغلاق</button>
      </div>
  </div>


  <div id="appContent" style="display: none;">
    <header>
      <div class="site-title" onclick="navigate('home')">منصة التفوق</div>

      <div class="nav-buttons">
        <button class="nav-btn active" id="homeBtn" onclick="navigate('home')"><i class="fas fa-chalkboard-teacher"></i> الدورات</button>
        <button class="nav-btn" id="materialsBtn" onclick="navigate('materials')"><i class="fas fa-book-open"></i> الملازم</button>
        <button class="nav-btn" id="examsBtn" onclick="navigate('exams')"><i class="fas fa-file-alt"></i> الامتحانات</button>
      </div>

      <div class="search-container">
        <input type="text" id="searchInput" placeholder="ابحث عن مدرس أو مادة...">
        <button id="searchButton"><i class="fas fa-search"></i> بحث</button>
      </div>

      <div id="studentCounter" class="student-counter">
        <i class="fas fa-users"></i> 
        <span>جارٍ التحميل...</span>
      </div>
      
      <button id="themeToggle"><i class="fas fa-moon"></i></button>

    </header>

    <div id="homePage" class="page active">
      <div class="teachers-section">
        <h2 class="section-title">اختر الدورة المطلوبة</h2>
        <div class="teachers-grid" id="teachersGrid">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="classesPage" class="page">
        <div class="classes-page">
            <div class="classes-list">
                <button class="back-button" onclick="navigate('home')"><i class="fas fa-arrow-right"></i> الرجوع لقائمة الدورات</button>
                <h2 class="section-title" id="courseTitle"></h2>
                <div id="classesList">
                    </div>
            </div>
            
            <div class="video-player-container" id="videoContainer">
                </div>
        </div>
    </div>


    <div id="videoPage" class="page">
      <div class="video-page-content">
          <button class="back-button" onclick="navigate('classes')"><i class="fas fa-arrow-right"></i> الرجوع لقائمة المحاضرات</button>
          <h2 class="video-title" id="videoPageTitle"></h2>
          <p style="color: var(--text-secondary); margin-bottom: 1.5rem;" id="videoPageDescription"></p>

          <div class="video-player-container" style="position: relative; top: 0;">
              <video controls crossorigin playsinline id="player"></video>
          </div>
      </div>
    </div>


    <div id="materialsPage" class="page">
      <h2 class="section-title">الملازم والمواد الدراسية</h2>
      <div class="materials-grid" id="materialsGrid">
          <div class="loading">
            <i class="fas fa-book-open" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <p>جارٍ تحميل الملازم...</p>
          </div>
      </div>
    </div>


    <div id="examsPage" class="page">
      <h2 class="section-title">الامتحانات والاختبارات</h2>
      <div class="exams-grid" id="examsGrid">
          <div class="loading">
            <i class="fas fa-file-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <p>جارٍ تحميل الامتحانات...</p>
          </div>
      </div>
    </div>

  </div>

  <button id="floatingContactBtn" style="display: none;" onclick="window.open('https://t.me/HayderAli_Al_Taie', '_blank')">
    <i class="fab fa-telegram-plane"></i>
  </button>

  <script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.1.5/hls.min.js"></script>


  <script>
    // ********* المتغيرات العامة *********
    let allTeachers = [];
    let allMaterials = [];
    let allExams = [];
    let accessCodeDatabase = {}; 
    const DEMO_CODE = "11111"; // كود الدخول التجريبي
    
    // ********** إعدادات التليجرام (يجب تعديلها) **********
    const TELEGRAM_BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN'; // <--- ضع توكن البوت الخاص بك هنا
    const TELEGRAM_CHAT_ID = 'YOUR_CHAT_ID'; // <--- ضع معرف الدردشة (Chat ID) الخاص بك هنا
    // *************************************************

    // ********* دوال التنقل والواجهة *********

    // تهيئة الثيم (الوضع الفاتح/الداكن)
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeToggleIcon(savedTheme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeToggleIcon(newTheme);
    }

    function updateThemeToggleIcon(theme) {
        const icon = document.getElementById('themeToggle').querySelector('i');
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    

    // دالة التنقل بين الصفحات
    function navigate(pageId, data = null) {
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active'));

      const targetPage = document.getElementById(pageId + 'Page');
      if (targetPage) {
        targetPage.classList.add('active');
      }

      const navButtons = document.querySelectorAll('.nav-btn');
      navButtons.forEach(btn => btn.classList.remove('active'));

      const targetBtn = document.getElementById(pageId + 'Btn');
      if (targetBtn) {
          targetBtn.classList.add('active');
      } else if (pageId === 'video' || pageId === 'classes') {
          // Keep the current main button active (e.g., 'home' for video/classes)
          document.getElementById('homeBtn').classList.add('active');
      }

      // Logic specific to certain pages
      if (pageId === 'classes' && data) {
        renderClasses(data.classes, data.teacherName);
      }
      if (pageId === 'materials') {
        renderMaterials(allMaterials);
      }
      if (pageId === 'exams') {
        renderExams(allExams);
      }

      window.scrollTo(0, 0); // Scroll to top on navigation
    }

    // ********* منطق تحميل البيانات والعرض *********

    // تحميل ملف data.json
    async function loadData() {
      if (allTeachers.length > 0) return; // Load only once
      try {
        const response = await fetch('data.json?t=' + Date.now());
        if (!response.ok) throw new Error('Data file not found');
        const data = await response.json();
        allTeachers = data.teachers || [];
        allMaterials = data.materials || [];
        allExams = data.exams || [];
      } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        // Display a fallback error message in the teachers grid
        const teachersGrid = document.getElementById('teachersGrid');
        teachersGrid.innerHTML = `
          <div class="teacher-card" style="grid-column: 1/-1; text-align: center; background: var(--card-color);">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--error); margin-bottom: 1rem;"></i>
            <h3>حدث خطأ في تحميل البيانات</h3>
            <p>يرجى التأكد من وجود ملف data.json في نفس المجلد.</p>
            <button onclick="location.reload()" class="download-btn" style="margin-top: 1rem;">
              <i class="fas fa-redo"></i> إعادة تحميل الصفحة
            </button>
          </div>
        `;
      }
    }

    // تحميل ملف codes.json
    async function loadCodes() {
      try {
        const response = await fetch('codes.json?t=' + Date.now());
        if (!response.ok) throw new Error('Codes file not found');
        accessCodeDatabase = await response.json();
      } catch (error) {
        console.error('خطأ في تحميل أكواد الدخول:', error);
      }
    }


    // عرض المدرسين (الدورات)
    function renderTeachers(teachers) {
      const teachersGrid = document.getElementById('teachersGrid');
      teachersGrid.innerHTML = '';
      if (teachers.length === 0) {
        teachersGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">لا توجد دورات متوفرة حالياً.</p>`;
        return;
      }

      teachers.forEach(teacher => {
        const card = document.createElement('div');
        card.className = 'teacher-card';
        card.setAttribute('data-id', teacher.id);
        card.onclick = () => navigate('classes', { classes: teacher.classes, teacherName: teacher.name });

        card.innerHTML = `
          <img src="${teacher.image || 'https://via.placeholder.com/400x200?text=Course+Image'}" alt="${teacher.name}" class="teacher-image">
          <h3>${teacher.name}</h3>
          <p>${teacher.subject}</p>
          <span style="position: absolute; top: 15px; left: 15px; background: ${teacher.isPaid ? 'var(--primary)' : 'var(--success)'}; color: white; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">
            ${teacher.isPaid ? 'مدفوعة' : 'مجانية'}
          </span>
        `;
        teachersGrid.appendChild(card);
      });
    }

    // عرض قائمة المحاضرات
    function renderClasses(classes, teacherName) {
      document.getElementById('courseTitle').innerText = teacherName;
      const classesListElement = document.getElementById('classesList');
      classesListElement.innerHTML = '';

      classes.forEach((classItem, index) => {
        const classDiv = document.createElement('div');
        classDiv.className = 'class-item';
        
        const title = document.createElement('h4');
        title.innerText = `${classItem.name}`;
        title.onclick = () => {
            const lecturesList = classDiv.querySelector('.lectures-list');
            lecturesList.style.display = lecturesList.style.display === 'block' ? 'none' : 'block';
            title.querySelector('i').className = lecturesList.style.display === 'block' ? 'fas fa-chevron-down' : 'fas fa-chevron-left';
        };
        
        const icon = document.createElement('i');
        icon.className = 'fas fa-chevron-left';
        icon.style.marginLeft = '10px';
        title.prepend(icon);

        const lecturesList = document.createElement('ul');
        lecturesList.className = 'lectures-list';

        classItem.lectures.forEach(lecture => {
          const lectureItem = document.createElement('li');
          lectureItem.className = 'lecture-item';
          lectureItem.innerHTML = `<i class="fas fa-video"></i> ${lecture.title}`;
          lectureItem.onclick = () => playVideo(lecture.url, lecture.title, lecture.description);
          lecturesList.appendChild(lectureItem);
        });

        classDiv.appendChild(title);
        classDiv.appendChild(lecturesList);
        classesListElement.appendChild(classDiv);

        // Auto expand the first class for better UX
        if (index === 0) {
            lecturesList.style.display = 'block';
            title.querySelector('i').className = 'fas fa-chevron-down';
        }
      });

      // Clear the video container when navigating to classes page
      document.getElementById('videoContainer').innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">اختر محاضرة من القائمة لبدء التشغيل.</p>';
    }

    // عرض الملازم
    function renderMaterials(materials) {
        const materialsGrid = document.getElementById('materialsGrid');
        materialsGrid.innerHTML = '';

        // [جديد] التحقق من الملازم والامتحانات
        if (materials.length === 0) {
            const userCode = localStorage.getItem('userAccessCode');
            if (userCode !== DEMO_CODE && accessCodeDatabase.hasOwnProperty(userCode) && accessCodeDatabase[userCode].used === true) {
                 materialsGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">لا توجد ملازم متوفرة حالياً.</p>`;
            } else {
                showUpgradeModal();
                materialsGrid.innerHTML = `
                    <div class="teacher-card" style="grid-column: 1/-1; text-align: center; background: var(--card-color);">
                        <i class="fas fa-lock" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
                        <h3>هذا القسم للمشتركين فقط</h3>
                        <p>للوصول للملازم، يرجى الحصول على كود الدخول المدفوع.</p>
                    </div>
                `;
            }
            return;
        }


        materials.forEach(material => {
            const card = document.createElement('div');
            card.className = 'material-card';
            
            card.innerHTML = `
                <h3>${material.title}</h3>
                <p>${material.subject}</p>
                <button class="download-btn" onclick="window.open('${material.url}', '_blank')">
                    <i class="fas fa-download"></i> تحميل الملزمة
                </button>
            `;
            materialsGrid.appendChild(card);
        });
    }

    // عرض الامتحانات
    function renderExams(exams) {
        const examsGrid = document.getElementById('examsGrid');
        examsGrid.innerHTML = '';

        if (exams.length === 0) {
            const userCode = localStorage.getItem('userAccessCode');
            if (userCode !== DEMO_CODE && accessCodeDatabase.hasOwnProperty(userCode) && accessCodeDatabase[userCode].used === true) {
                 examsGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">لا توجد امتحانات متوفرة حالياً.</p>`;
            } else {
                showUpgradeModal();
                examsGrid.innerHTML = `
                    <div class="teacher-card" style="grid-column: 1/-1; text-align: center; background: var(--card-color);">
                        <i class="fas fa-lock" style="font-size: 3rem; color: var(--warning); margin-bottom: 1rem;"></i>
                        <h3>هذا القسم للمشتركين فقط</h3>
                        <p>للوصول للامتحانات، يرجى الحصول على كود الدخول المدفوع.</p>
                    </div>
                `;
            }
            return;
        }

        exams.forEach(exam => {
            const card = document.createElement('div');
            card.className = 'exam-card';
            
            card.innerHTML = `
                <h3>${exam.title}</h3>
                <p>${exam.subject}</p>
                <button class="download-btn" onclick="window.open('${exam.url}', '_blank')">
                    <i class="fas fa-external-link-alt"></i> بدء الامتحان
                </button>
            `;
            examsGrid.appendChild(card);
        });
    }

    // ********* منطق تشغيل الفيديو *********
    let player; // Plyr instance
    const videoElement = document.getElementById('player');

    // حفظ تقدم المشاهدة في localStorage
    function saveVideoProgress(url, time) {
        if (!url) return;
        const progress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
        progress[url] = time;
        localStorage.setItem('videoProgress', JSON.stringify(progress));
    }

    // استرداد تقدم المشاهدة
    function getVideoProgress(url) {
        if (!url) return 0;
        const progress = JSON.parse(localStorage.getItem('videoProgress') || '{}');
        return progress[url] || 0;
    }

    // دالة لتشغيل الفيديو
    function playVideo(url, title, description) {
        // تحديث معلومات الفيديو في صفحة الفيديو المنفصلة
        document.getElementById('videoPageTitle').innerText = title;
        document.getElementById('videoPageDescription').innerText = description;

        // تهيئة مشغل Plyr إذا لم يتم تهيئته بعد
        if (!player) {
            player = new Plyr(videoElement, {
              controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
              autoplay: true,
              disableContextMenu: true, // لمنع خيارات التحميل
              keyboard: { focused: false, global: false },
              ratio: '16:9'
            });
            player.on('timeupdate', () => {
                saveVideoProgress(videoElement.src, player.currentTime);
            });
            player.on('pause', () => {
                saveVideoProgress(videoElement.src, player.currentTime);
            });
            player.on('ended', () => {
                // عند الانتهاء، اضبط الوقت على البداية (أو اتركه كما هو حسب الرغبة)
                saveVideoProgress(videoElement.src, 0);
            });
        }
        
        // التحقق مما إذا كان رابط يوتيوب
        if (url.includes('youtu.be') || url.includes('youtube.com')) {
            player.source = {
                type: 'video',
                sources: [
                    {
                        src: url,
                        provider: 'youtube',
                    },
                ],
            };
            player.on('ready', () => {
              // لا يمكننا حفظ واستعادة الوقت تلقائياً لـ YouTube iframe، لذا سنكتفي بالتشغيل
              player.play();
            });

        } else if (url.includes('.m3u8')) {
            // تشغيل HLS (M3U8) باستخدام hls.js
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoElement);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    player.currentTime = getVideoProgress(url);
                    player.play();
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                // تشغيل أصلي على Safari (iOS/macOS)
                videoElement.src = url;
                videoElement.addEventListener('loadedmetadata', () => {
                    player.currentTime = getVideoProgress(url);
                    player.play();
                });
            }
        } else {
            // تشغيل مباشر (MP4, إلخ)
            videoElement.src = url;
            player.currentTime = getVideoProgress(url);
            player.play();
        }

        // إظهار صفحة المشغل المنفصلة
        navigate('video');
    }

    // ********* منطق تسجيل الدخول *********
    
    // دالة تحديث عداد الطلاب (المستخدمين المفعلين)
    function updateStudentCounter(codes) {
        const counterElement = document.getElementById('studentCounter').querySelector('span');
        const activeStudents = Object.values(codes).filter(code => code.used === true).length;
        counterElement.innerText = `${activeStudents} طالب فعال`;
    }

    // الإجراءات التي تتم بعد نجاح تسجيل الدخول
    function loginSuccess() {
        closeModal('loginModal');
        closeModal('selectionModal');
        document.getElementById('appContent').style.display = 'block';
        document.getElementById('floatingContactBtn').style.display = 'flex';
        document.body.style.overflow = 'auto'; // Restore scrolling

        const userCode = localStorage.getItem('userAccessCode');
        
        loadData().then(() => {
            if (userCode === DEMO_CODE) {
                // دخول تجريبي - عرض الدورات المجانية فقط
                const freeCourses = allTeachers.filter(t => t.isPaid === false);
                renderTeachers(freeCourses);
                // إخفاء الملازم والامتحانات في الوضع التجريبي
                document.getElementById('materialsBtn').style.display = 'none';
                document.getElementById('examsBtn').style.display = 'none';
            } else {
                // دخول مدفوع - عرض جميع الدورات
                const paidCourses = allTeachers; // Assuming paid user sees all courses
                renderTeachers(paidCourses);
                renderMaterials(allMaterials); 
                renderExams(allExams); 
                document.getElementById('materialsBtn').style.display = 'block';
                document.getElementById('examsBtn').style.display = 'block';
            }
        });
        navigate('home');
        updateStudentCounter(accessCodeDatabase);
    }
    
    function openLoginModal() {
      closeModal('selectionModal');
      openModal('loginModal');
    }

    function handleTrialLogin() {
        // في الوضع التجريبي نستخدم كود ثابت ونبدأ مباشرة
        localStorage.setItem('userAccessCode', DEMO_CODE);
        localStorage.setItem('studentName', 'طالب تجريبي'); 
        localStorage.setItem('studentPhone', '0000000000'); 
        loginSuccess();
    }


    // [MODIFIED] دالة تسجيل الدخول الرئيسية
    async function handleLogin() {
        const enteredCode = document.getElementById('accessCodeInput').value.trim();
        // [NEW] Get student information and pledge status
        const studentName = document.getElementById('studentNameInput').value.trim();
        const studentPhone = document.getElementById('studentPhoneInput').value.trim();
        const isAcknowledged = document.getElementById('acknowledgmentCheckbox').checked;

        const errorElement = document.getElementById('loginError');
        errorElement.style.display = 'none';

        // [NEW] Validation for Name, Phone, and Pledge
        if (!studentName) {
            errorElement.innerText = 'الرجاء إدخال الاسم الكامل.';
            errorElement.style.display = 'block';
            return;
        }

        if (!studentPhone) {
            errorElement.innerText = 'الرجاء إدخال رقم الهاتف.';
            errorElement.style.display = 'block';
            return;
        }

        if (!isAcknowledged) {
            errorElement.innerText = 'يجب الموافقة على التعهد للمتابعة.';
            errorElement.style.display = 'block';
            return;
        }

        // Existing code validation
        if (!enteredCode) {
            errorElement.innerText = 'الرجاء إدخال كود الدخول.';
            errorElement.style.display = 'block';
            return;
        }
        
        // ********** [NEW] منطق إرسال البيانات عبر Telegram Bot API **********
        // نتحقق أولاً من وجود التوكن والـ Chat ID
        if (TELEGRAM_BOT_TOKEN !== '8058638214:AAH5EwEyC4UYBDs1YTh37Syn8rXAniy1udA' && TELEGRAM_CHAT_ID !== '5064097475') {
            const messageText = `*تسجيل دخول جديد (منصة التفوق)*\n\n` +
                                `*الاسم:* ${studentName}\n` +
                                `*الهاتف:* ${studentPhone}\n` +
                                `*الكود المُدخل:* \`${enteredCode}\`\n` +
                                `*التعهد:* ${isAcknowledged ? 'تمت الموافقة' : 'لم تتم الموافقة'}\n` +
                                `---------------------\n` +
                                `الرجاء تحديث ملف codes.json وإلغاء تفعيل الأكواد المستخدمة عند الضرورة.`;

            const telegramApiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const params = new URLSearchParams({
                chat_id: TELEGRAM_CHAT_ID,
                text: messageText,
                parse_mode: 'Markdown' // لاستخدام التنسيق الغامق والمائل
            }).toString();

            try {
                // إرسال البيانات إلى Telegram Bot API
                const response = await fetch(`${telegramApiUrl}?${params}`, {
                    method: 'GET' // يمكن استخدام GET أو POST لهذه العملية
                });

                if (response.ok) {
                    console.log('تم إرسال بيانات الطالب بنجاح عبر Telegram.');
                } else {
                    console.error('حدث خطأ في إرسال البيانات إلى Telegram. تأكد من التوكن والـ Chat ID و صلاحيات البوت.');
                }
            } catch (error) {
                console.error('فشل الاتصال بخدمة Telegram API:', error);
            }
        } else {
            console.warn('تنبيه: لم يتم إرسال البيانات إلى Telegram. يرجى تعديل TELEGRAM_BOT_TOKEN و TELEGRAM_CHAT_ID في ملف index.html.');
        }
        // ********** [END NEW] منطق إرسال البيانات عبر Telegram Bot API **********


        // ********** منطق التحقق من الكود (كما كان سابقاً) **********
        if (accessCodeDatabase.hasOwnProperty(enteredCode)) {
            const codeDetails = accessCodeDatabase[enteredCode];
            if (codeDetails.used === true) {
                errorElement.innerText = 'هذا الكود مستخدم بالفعل. تواصل مع المدرس.';
                errorElement.style.display = 'block';
            } else {
                // [MODIFIED] Store student info along with the code 
                localStorage.setItem('userAccessCode', enteredCode); 
                localStorage.setItem('studentName', studentName); // Store student name
                localStorage.setItem('studentPhone', studentPhone); // Store student phone
                
                // Success flow
                loginSuccess();
                startPeriodicCheck(); 
                updateStudentCounter(accessCodeDatabase); 
                
                // [MODIFIED] Alert message to inform the user and the admin about the new data
                console.warn(`تم تفعيل الكود: ${enteredCode}. يرجى تحديث ملف codes.json وجعل "used": true. **بيانات الطالب الجديدة**: الاسم: ${studentName}, الهاتف: ${studentPhone}`);
                alert(`تم تفعيل الكود بنجاح.\nسيتم إرسال بياناتك للمدرس عبر التليجرام.\nتواصل مع المدرس لتأكيد التفعيل النهائي للكود وتحديث ملف codes.json.`);
            }
        } else {
            errorElement.innerText = 'كود الدخول غير صحيح. حاول مرة أخرى.';
            errorElement.style.display = 'block';
        }
    }


    // دوال فتح وإغلاق النوافذ
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'none';
    }

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = 'flex';
    }

    function showUpgradeModal() {
        openModal('upgradeModal');
    }

    // منطق التحقق الدوري للطرد
    const fiveMinutesInMs = 300000;

    function checkRevocationStatus() {
        const userCode = localStorage.getItem('userAccessCode');
        if (!userCode || userCode === DEMO_CODE) return; 

        // Fetch the codes.json again to get the latest status
        fetch('codes.json?t=' + Date.now())
        .then(response => {
            if (!response.ok) throw new Error('Codes file not found');
            return response.json();
        })
        .then(codesFromServer => {
            const codeStatus = codesFromServer[userCode];
            if (!codeStatus || codeStatus.used === false) {
                // Code is not found or has been revoked (set to used: false)
                localStorage.removeItem('userAccessCode');
                localStorage.removeItem('studentName');
                localStorage.removeItem('studentPhone');
                alert('تم إلغاء تفعيل الكود من قبل الإدارة. سيتم إخراجك من التطبيق.');
                location.reload(); 
            }
            // Update the in-memory database
            accessCodeDatabase = codesFromServer;
            updateStudentCounter(accessCodeDatabase);
        })
        .catch(error => {
            console.error('خطأ في التحقق الدوري من حالة الكود:', error);
            // Optionally: keep the user logged in if the server check fails
        });
    }

    let revocationCheckInterval;

    function startPeriodicCheck() {
        if (revocationCheckInterval) clearInterval(revocationCheckInterval);
        revocationCheckInterval = setInterval(checkRevocationStatus, fiveMinutesInMs);
    }
    

    // منطق تسجيل الدخول التلقائي عند بدء التشغيل
    async function checkAutoLogin() {
        await loadCodes(); // Load codes before checking
        const savedCode = localStorage.getItem('userAccessCode');
        const isLocalFile = window.location.protocol === 'file:';

        if (isLocalFile) {
            if (savedCode === DEMO_CODE) {
                console.log('دخول تلقائي بوضع التجربة المحلية.');
                loginSuccess();
                startPeriodicCheck();
                return;
            }
            // في الوضع المحلي نفتح شاشة الاختيار ما لم يكن هناك كود تجريبي محفوظ
            document.getElementById('selectionModal').style.display = 'flex';
            return;
        }

        if (!savedCode) {
            document.getElementById('selectionModal').style.display = 'flex';
            return;
        }
        
        if (savedCode === DEMO_CODE) {
            console.log('دخول تلقائي بالوضع التجريبي.');
            loginSuccess();
            // لا حاجة للتحقق الدوري في الوضع التجريبي
            return;
        }

        if (accessCodeDatabase.hasOwnProperty(savedCode)) {
            const codeDetails = accessCodeDatabase[savedCode];
            if (codeDetails.used === true) {
                console.log('دخول تلقائي ناجح (مستخدم مُفعّل).');
                loginSuccess();
                startPeriodicCheck();
                return;
            } 
            if (codeDetails.used === false) {
                localStorage.removeItem('userAccessCode');
                localStorage.removeItem('studentName');
                localStorage.removeItem('studentPhone');
                alert('تم إلغاء تفعيل هذا الكود من قبل الإدارة. يرجى استخدام كود جديد.');
                document.getElementById('selectionModal').style.display = 'flex';
                return;
            }
        } else {
            localStorage.removeItem('userAccessCode');
            localStorage.removeItem('studentName');
            localStorage.removeItem('studentPhone');
            alert('تم إلغاء صلاحية هذا الكود أو لم يتم تفعيله بعد. يرجى مراجعة المدرس.');
            document.getElementById('selectionModal').style.display = 'flex';
            return;
        }
    }


    // ********* منطق حماية التطبيق *********

    // 1. فحص أدوات المطورين (DevTools)
    const threshold = 160;
    let devtoolsOpen = false;

    const check = () => {
      const start = performance.now();
      const sizeCheck = window.outerWidth - window.innerWidth > 100 || window.outerHeight - window.innerHeight > 100;

      try { new Function('debugger')(); } catch (e) {}
      
      const end = performance.now();

      if (sizeCheck || (end - start) > threshold) {
        if (!devtoolsOpen) {
          devtoolsOpen = true;
          document.body.innerHTML = '<div style="background: black; color: red; font-size: 2rem; position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999;"><h1>! خطأ !</h1><p style="font-size: 1.2rem;">تم اكتشاف محاولة الوصول غير المصرح بها (DevTools).</p><p style="font-size: 1.2rem;">يرجى إغلاق أدوات المطورين.</p></div>';
          
          const preventExecution = setInterval(() => {
              try { new Function('debugger')(); } catch (e) {
                  if (!window.outerWidth) clearInterval(preventExecution);
              }
          }, 100);
        }
      } else {
        devtoolsOpen = false;
      }
    };
    // setInterval(check, 1000); // Check every second
    
    // منع النقر بالزر الأيمن والتحديد
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());


    // *** منطق تهيئة التطبيق المعدل ***
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      // إخفاء كل شيء في البداية
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('appContent').style.display = 'none';
      document.getElementById('floatingContactBtn').style.display = 'none'; 
      document.getElementById('upgradeModal').style.display = 'none'; 

      document.body.style.overflow = 'hidden';
      
      // نبدأ بعملية تسجيل الدخول التلقائي أو نفتح شاشة الاختيار
      checkAutoLogin();
    });
    // نهاية التهيئة

  </script>
 </body>
</html>
