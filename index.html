<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>منصة التفوق التعليمية</title>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;600;700;800&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js"></script>

  <style>
    :root {
      /* تحسين الألوان لتبدو أقوى وأكثر احترافية (Dark Slate/Aqua Theme) */
      --primary: #00bcd4; /* لون أساسي بارز (Cyan/Aqua) */
      --primary-dark: #00a0b2;
      --primary-light: #33e1f7;
      --secondary: #2196f3;
      --accent: #4caf50; /* النجاح */
      --warning: #ff9800; /* تنبيه */
      --error: #f44336; /* خطأ/مدفوع */
      --bg-color: #0f172a; /* خلفية داكنة جداً (Slate) */
      --bg-secondary: #1e293b; /* لون ثانوي داكن */
      --text-color: #e2e8f0; /* نص فاتح قليلاً */
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --card-bg: #1e293b;
      --plyr-color-main: var(--primary);
      --success: var(--accent);
    }

    body {
      font-family: 'Almarai', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      direction: rtl;
      transition: background-color 0.3s, color 0.3s;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3, h4, h5 {
        color: var(--text-color);
        font-weight: 700;
        margin-top: 0;
    }
    
    /* الستايل الخاص بالـ Modals */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.85); /* خلفية داكنة أكثر */
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(5px); /* تأثير ضبابي جميل */
    }

    .modal-content {
      background-color: var(--bg-secondary);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      position: relative;
      max-width: 90%;
      width: 450px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7); /* ظل أقوى */
      border: 1px solid var(--border-color);
    }

    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      transition: color 0.3s;
    }

    .close-modal:hover {
      color: var(--error);
    }
    
    /* أنماط البطاقات والأزرار - تحسينات التصميم */
    .teacher-card, .class-card, .lecture-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        border: 2px solid transparent; /* إضافة حدود لتأثير أجمل */
        text-align: right;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .teacher-card:hover {
        transform: translateY(-8px); /* رفع أكبر */
        box-shadow: 0 10px 25px rgba(0, 188, 212, 0.3); /* ظل بلون Primary */
        border-color: var(--primary);
    }
    
    .class-card, .lecture-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
    }
    
    /* أزرار قوية */
    .download-btn {
        background-color: var(--primary);
        color: var(--bg-color); /* نص داكن على خلفية فاتحة */
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 17px;
        font-weight: 700;
        transition: background-color 0.3s, transform 0.1s;
        margin-top: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .download-btn:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
    }
    
    .status-tag {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        margin-top: 10px;
    }
    .status-tag.paid { background-color: var(--error); color: white; }
    .status-tag.free { background-color: var(--accent); color: var(--bg-color); }
    
    /* حقول الإدخال */
    input[type="text"], input[type="tel"] {
        width: 90%;
        box-sizing: border-box;
        text-align: right !important;
        background: var(--bg-color) !important;
        color: var(--text-color) !important;
        border: 1px solid var(--border-color) !important;
        transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="tel"]:focus {
        border-color: var(--primary) !important;
        outline: none;
    }

    /* أنماط أخرى */
    #backButton {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10;
        background-color: var(--secondary);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s, transform 0.3s;
    }
    #backButton:hover {
        background-color: var(--primary-dark);
        transform: scale(1.1);
    }
    
    /* تخطيط الشبكة */
    .grid-layout {
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 20px; 
        margin-top: 20px;
    }
    
    /* تحسين تنسيق المحاضرات */
    .lecture-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .lecture-header i {
        color: var(--primary);
        margin-left: 10px;
        font-size: 1.2rem;
    }
    .lecture-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 10px;
    }

    /* معلومات المدرس في صفحة الفصول */
    .teacher-info {
        background-color: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* إخفاء شاشة الترحيب الأصلية لضمان الدخول المباشر */
    #selectionModal { display: none !important; }

    /* توست للإشعارات */
    #toast {
      visibility: hidden; 
      min-width: 250px; 
      margin-left: -125px; 
      background-color: #333; 
      color: #fff; 
      text-align: center; 
      border-radius: 2px; 
      padding: 16px; 
      position: fixed; 
      z-index: 1; 
      right: 30px; 
      bottom: 30px;
      font-size: 17px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
      transition: visibility 0.3s, opacity 0.3s;
    }

    #toast.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    
    @keyframes fadein {
      from {bottom: 0; opacity: 0;} 
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;} 
      to {bottom: 0; opacity: 0;}
    }

  </style>

 </head>
 <body>

  <button id="backButton" onclick="goBack()">
    <i class="fas fa-arrow-right"></i>
  </button>

  <a id="floatingContactBtn" href="https://t.me/yourtelegramid" target="_blank" style="display: none; position: fixed; bottom: 20px; left: 20px; background: var(--secondary); color: white; padding: 15px; border-radius: 50%; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 900;">
    <i class="fab fa-telegram-plane"></i>
  </a>
  
  <div id="toast"></div>

  <div id="pledgeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <i class="fas fa-gavel" style="font-size: 3rem; color: var(--error); margin-bottom: 1rem;"></i>
      <h3>تعهد قانوني وإقرار بالشروط</h3>
      <div style="text-align: right; margin-bottom: 1.5rem; border: 1px solid var(--border-color); padding: 1rem; border-radius: 10px; background: var(--bg-color);">
        <p style="font-weight: 600; color: var(--error); margin-bottom: 1rem;">أوافق على الشروط التالية للدخول إلى الدورة الإلكترونية:</p>
        <ul style="list-style: none; padding-right: 0; margin-right: 0; text-align: right;">
          <li style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle" style="color: var(--success); margin-left: 0.5rem;"></i> جميع المحاضرات محمية بحقوق النشر ومخصصة للمشترك فقط.</li>
          <li style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle" style="color: var(--success); margin-left: 0.5rem;"></i> لا يجوز مشاركة الكود أو المحتوى مع أي شخص آخر.</li>
          <li style="margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle" style="color: var(--warning); margin-left: 0.5rem;"></i> **تعهد قانوني:** في حالة تم تسريب المحاضرات أو تم تسريب الكود، فإنك تعرض نفسك للمساءلة القانونية.</li>
        </ul>
      </div>
      
      <div style="display: flex; gap: 1rem; justify-content: center;">
          <button class="download-btn" onclick="closeModal('pledgeModal'); openModal('loginModal')" style="background: var(--primary);">
              <i class="fas fa-signature"></i> أوافق وأقر بالتعهد (دخول)
          </button>
          <button class="download-btn" onclick="closeModal('pledgeModal')" style="background: var(--error);">
              <i class="fas fa-times"></i> لا أوافق (إلغاء)
          </button>
      </div>
    </div>
  </div>

  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal('loginModal')"><i class="fas fa-times"></i></button>
      <i class="fas fa-lock-open" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
      <h3>تسجيل الدخول للدورة الالكترونية</h3>
      <p style="margin-bottom: 1rem; color: var(--text-secondary);">الرجاء إدخال بياناتك وكود الدخول لتفعيل الدورة.</p>
      <input type="text" id="studentNameInput" placeholder="اسم الطالب الثلاثي" required style="text-align: center; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;">
      <input type="tel" id="studentPhoneInput" placeholder="رقم الهاتف (للتفعيل)" required style="text-align: center; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;">
      <input type="text" id="loginCode" placeholder="كود الدخول (مثال: XXXX-XXXX-XXXX-XXXX)" required style="text-align: center; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;">
      <p id="loginError" style="color: var(--error); margin-bottom: 1rem; display: none;"></p>
      <button id="loginButton" class="download-btn" onclick="processLogin()"> <i class="fas fa-sign-in-alt"></i> تفعيل الكود والدخول </button>
    </div>
  </div>
  
  <div id="selectionModal" class="modal" style="display: none;"></div>

  <div id="appContent" class="container" style="display: none;">
    
    <div id="home" class="page">
      <h2>اختر الدورة المناسبة:</h2>
      <div id="teachersContainer" class="grid-layout">
        </div>
    </div>

    <div id="classes" class="page" style="display: none;">
      <div class="teacher-info" style="text-align: center; margin-bottom: 30px;">
        <img id="teacherImage" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid var(--primary); box-shadow: 0 0 15px rgba(0, 188, 212, 0.5);">
        <h1 id="teacherName" style="font-size: 2rem;">اسم المدرس</h1>
        <p id="teacherSubject" style="color: var(--text-secondary); font-size: 1.1rem;">مادة / موضوع الدورة</p>
      </div>
      <h2>أقسام الدورة:</h2>
      <div id="classesContainer" class="grid-layout">
        </div>
    </div>

    <div id="lectures" class="page" style="display: none;">
      <h2 id="lecturesPageTitle">المحاضرات</h2>
      <div id="lecturesContainer" style="margin-top: 20px;">
        </div>
    </div>

    <div id="videoPlayer" class="page" style="display: none;">
      <h2 id="videoTitle" style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">عنوان المحاضرة</h2>
      <div class="player-container" style="max-width: 900px; margin: 20px auto;">
        <video id="player" playsinline controls></video>
      </div>
      <p id="videoDescription" style="text-align: center; color: var(--text-secondary); padding: 10px; border-top: 1px solid var(--border-color);"></p>
    </div>
  </div>

  <script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>
  
  <script>
    let player;
    let currentTeacher;
    let allTeachers = [];
    let accessCodes = {};
    let demoCode = null;
    let isCodeLoggedIn = false;
    let selectedLecture = null;
    let isPlaying = false;
    let lastPlayedTime = 0; 

    // دالة عامة لفتح النماذج
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // دالة عامة لإغلاق النماذج
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        document.body.style.overflow = 'auto';
        if (modalId === 'loginModal') {
            document.getElementById('loginError').style.display = 'none';
        }
    }
    
    // دالة لعرض رسائل Toast
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        if (!toast) return; 
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => {
            toast.className = toast.className.replace('show', '');
        }, 3000);
    }

    // دالة للتنقل بين الصفحات
    function navigate(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';
        
        // إظهار زر العودة في الصفحات الداخلية
        if (pageId === 'home') {
             document.getElementById('backButton').style.display = 'none';
        } else {
             document.getElementById('backButton').style.display = 'flex';
        }
    }

    // دالة للعودة إلى الصفحة الرئيسية
    function goBack() {
        navigate('home');
        // تأكد من إيقاف المشغل عند العودة للصفحة الرئيسية
        if (player) {
            player.pause();
        }
    }

    // [معدل] اختيار المدرس (الدورة) - يتضمن منطق التعهد الجديد
    function selectTeacher(id) {
        currentTeacher = allTeachers.find(t => t.id === id);
        if (!currentTeacher) return;

        // إذا كانت الدورة مدفوعة، نفتح نافذة التعهد أولاً إذا لم يكن مسجلاً دخوله
        if (currentTeacher.isPaid) {
            const savedCode = localStorage.getItem('userAccessCode');
            
            // إذا لم يكن هناك كود محفوظ، نفتح نافذة التعهد أولاً
            if (!savedCode) {
                openModal('pledgeModal');
                return; // نوقف عملية الدخول العادية
            }
        }

        // للمستخدمين المجانيين أو المستخدم المدفوع الذي سجل دخوله بالفعل
        document.getElementById('teacherImage').src = currentTeacher.image;
        document.getElementById('teacherImage').alt = currentTeacher.name;
        document.getElementById('teacherName').textContent = currentTeacher.name;
        document.getElementById('teacherSubject').textContent = currentTeacher.subject;
        
        const classesToShow = currentTeacher.classes;
        renderClasses(classesToShow);
        
        navigate('classes');
    }


    // دالة لعرض الفصول
    function renderClasses(classes) {
        const classesContainer = document.getElementById('classesContainer');
        classesContainer.innerHTML = '';
        classes.forEach(cls => {
            const classCard = document.createElement('div');
            classCard.className = 'class-card';
            classCard.innerHTML = `
                <div class="class-header">
                    <i class="fas fa-book-open"></i>
                    <h4>${cls.name}</h4>
                </div>
                <button class="download-btn" onclick="renderLectures('${cls.name}')" style="width: 100%; margin-top: 10px; background: var(--secondary);">عرض المحاضرات (${cls.lectures.length})</button>
            `;
            classesContainer.appendChild(classCard);
        });
    }

    // دالة لعرض المحاضرات داخل الفصل المحدد
    function renderLectures(className) {
        const cls = currentTeacher.classes.find(c => c.name === className);
        if (!cls) return;

        const lecturesContainer = document.getElementById('lecturesContainer');
        lecturesContainer.innerHTML = '';
        
        document.getElementById('lecturesPageTitle').textContent = `محاضرات: ${cls.name}`;

        cls.lectures.forEach((lecture, index) => {
            const isAvailable = true;

            const lectureCard = document.createElement('div');
            lectureCard.className = 'lecture-card';
            
            lectureCard.onclick = isAvailable ? () => playLecture(lecture) : null;
            
            lectureCard.innerHTML = `
                <div class="lecture-header">
                    <i class="fas fa-video"></i>
                    <h5 class="${isAvailable ? '' : 'unavailable'}">${lecture.title}</h5>
                </div>
                <span class="lecture-status ${isAvailable ? 'available' : 'unavailable'}">
                    ${isAvailable ? 'متاحة للعرض' : 'غير متاحة'}
                </span>
                <p class="lecture-description">${lecture.description}</p>
            `;
            lecturesContainer.appendChild(lectureCard);
        });
        navigate('lectures');
    }

    // دالة تشغيل المحاضرة
    function playLecture(lecture) {
        selectedLecture = lecture;
        navigate('videoPlayer');
        
        if (player) {
            player.destroy(); 
        }

        const videoElement = document.getElementById('player');
        
        // تهيئة المشغل لـ YouTube أو ملف عادي
        if (lecture.url.includes('youtu.be') || lecture.url.includes('youtube.com')) {
            const url = new URL(lecture.url);
            let videoId;
            if (url.hostname === 'youtu.be') {
                videoId = url.pathname.substring(1);
            } else if (url.searchParams.get('v')) {
                videoId = url.searchParams.get('v');
            }
            
            player = new Plyr(videoElement, {
                controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'fullscreen'],
                ratio: '16:9',
                fullscreen: { enabled: true, fallback: true, iosNative: true },
                quality: { default: 'hd1080', options: ['hd1080', 'hd720', 'large', 'medium', 'small'] }
            });

            player.source = {
                type: 'video',
                sources: [
                    {
                        src: videoId,
                        provider: 'youtube',
                    },
                ],
            };
            
        } else {
            // للملفات العادية (MP4 مثلاً)
            player = new Plyr(videoElement, {
                controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'fullscreen'],
                ratio: '16:9',
                fullscreen: { enabled: true, fallback: true, iosNative: true },
            });
            player.source = {
                type: 'video',
                sources: [
                    {
                        src: lecture.url,
                        type: 'video/mp4',
                    },
                ],
            };
        }
        
        if (currentTeacher.isPaid && localStorage.getItem('lastPlayedTime')) {
            lastPlayedTime = parseFloat(localStorage.getItem('lastPlayedTime'));
        }
        
        player.on('ready', () => {
            if (lastPlayedTime > 0) {
                 player.currentTime = lastPlayedTime;
            }
        });

        player.play();
        
        document.getElementById('videoTitle').textContent = lecture.title;
        document.getElementById('videoDescription').textContent = lecture.description;
    }


    // تحميل بيانات المدرسين
    async function loadData() {
        try {
            const response = await fetch('data.json?t=' + Date.now()); 
            if (!response.ok) throw new Error('Failed to load data.json');
            const data = await response.json();
            allTeachers = data.teachers;
            demoCode = data.DEMO_CODE;
            renderTeachers(allTeachers); 
        } catch (error) {
            console.error('Error loading data:', error);
            showToast('فشل في تحميل بيانات التطبيق.', 'error');
        }
    }
    
    // تحميل أكواد الدخول
    async function loadAccessCodes() {
        try {
            const response = await fetch('codes.json?t=' + Date.now()); 
            if (!response.ok) throw new Error('Failed to load codes.json');
            accessCodes = await response.json();
        } catch (error) {
            console.error('Error loading access codes:', error);
        }
    }

    // عرض بطاقات المدرسين
    function renderTeachers(teachers) {
        const teachersContainer = document.getElementById('teachersContainer');
        teachersContainer.innerHTML = '';
        teachers.forEach(teacher => {
            const teacherCard = document.createElement('div');
            teacherCard.className = 'teacher-card';
            teacherCard.onclick = () => selectTeacher(teacher.id);
            teacherCard.innerHTML = `
                <img src="${teacher.image}" alt="${teacher.name}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; float: right; margin-left: 15px; border: 2px solid var(--primary-light);">
                <div>
                    <h4>${teacher.name}</h4>
                    <p style="color: var(--text-secondary); margin-top: 5px;">${teacher.subject}</p>
                    <span class="status-tag ${teacher.isPaid ? 'paid' : 'free'}">${teacher.isPaid ? 'دورة إلكترونية' : 'دورة تجريبية'}</span>
                </div>
            `;
            teachersContainer.appendChild(teacherCard);
        });
    }

    // دالة لتسجيل الدخول بنجاح
    function loginSuccess() {
        isCodeLoggedIn = true;
        closeModal('loginModal');
        showToast('تم تفعيل الدورة بنجاح. مرحباً بك.', 'success');
        renderTeachers(allTeachers);
        navigate('home');
    }

    // التحقق من الدخول التلقائي
    function checkAutoLogin() {
        const savedCode = localStorage.getItem('userAccessCode');
        const savedDevice = localStorage.getItem('deviceIdentifier');
        
        if (savedCode) {
            if (accessCodes.hasOwnProperty(savedCode) && accessCodes[savedCode].used === true) {
                if (accessCodes[savedCode].device === savedDevice) {
                    loginSuccess();
                    startPeriodicCheck();
                    return;
                }
            }
            localStorage.removeItem('userAccessCode');
        }
    }

    // [معدل] دالة معالجة تسجيل الدخول بالكود - تتضمن الاسم والهاتف
    function processLogin() {
        const enteredCode = document.getElementById('loginCode').value.trim().toUpperCase();
        const studentName = document.getElementById('studentNameInput').value.trim();
        const studentPhone = document.getElementById('studentPhoneInput').value.trim();
        const errorElement = document.getElementById('loginError');

        errorElement.style.display = 'none';

        if (!studentName || !studentPhone || !enteredCode) {
            errorElement.innerText = 'الرجاء ملء جميع الحقول (الاسم، الهاتف، والكود).';
            errorElement.style.display = 'block';
            return;
        }

        fetch('codes.json?t=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error('Codes file not found');
                return response.json();
            })
            .then(accessCodeDatabase => {
                if (accessCodeDatabase.hasOwnProperty(enteredCode)) {
                    const codeDetails = accessCodeDatabase[enteredCode];
                    if (codeDetails.used === true) {
                        errorElement.innerText = 'هذا الكود مستخدم بالفعل. تواصل مع المدرس.';
                        errorElement.style.display = 'block';
                    } else {
                        // حفظ بيانات الطالب
                        localStorage.setItem('userAccessCode', enteredCode); 
                        localStorage.setItem('studentName', studentName); 
                        localStorage.setItem('studentPhone', studentPhone); 

                        // تسجيل البيانات للمطور/المدرس في Console
                        console.warn(`تم تفعيل الكود: ${enteredCode}. 
بواسطة: ${studentName} 
الهاتف: ${studentPhone}. 
يرجى تحديث ملف codes.json وجعل "used": true، وإضافة اسم الطالب ورقم هاتفه.`);

                        loginSuccess();
                        startPeriodicCheck(); 
                        // updateStudentCounter(accessCodeDatabase); 
                        
                        alert(`تم تفعيل الكود بنجاح. تواصل مع المدرس لتأكيد التفعيل النهائي للكود.`);
                    }
                } else {
                    errorElement.innerText = 'كود الدخول غير صحيح. حاول مرة أخرى.';
                    errorElement.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('فشل في جلب ملف الرموز:', error);
                errorElement.innerText = 'حدث خطأ أثناء الاتصال بالخادم. حاول لاحقًا.';
                errorElement.style.display = 'block';
            });
    }

    // توليد معرف فريد للجهاز
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // دالة بدء فحص الحالة
    function startPeriodicCheck() {
        const checkInterval = 1000 * 60 * 15; // 15 دقيقة
        setInterval(checkSubscriptionStatus, checkInterval);
    }
    
    // التحقق من حالة الاشتراك 
    function checkSubscriptionStatus() {
        const savedCode = localStorage.getItem('userAccessCode');
        const savedDevice = localStorage.getItem('deviceIdentifier');

        if (!savedCode || !savedDevice) return;

        fetch('codes.json?t=' + Date.now())
            .then(response => response.json())
            .then(accessCodeDatabase => {
                if (accessCodeDatabase.hasOwnProperty(savedCode)) {
                    const codeDetails = accessCodeDatabase[savedCode];

                    if (codeDetails.used === true && codeDetails.device === savedDevice) {
                        isCodeLoggedIn = true;
                    } else if (codeDetails.used === true && codeDetails.device !== savedDevice) {
                        isCodeLoggedIn = false;
                        localStorage.removeItem('userAccessCode');
                        showToast('تم إلغاء تفعيل الدورة من هذا الجهاز، الكود مستخدم بالفعل على جهاز آخر.', 'error');
                        navigate('home');
                        renderTeachers(allTeachers);
                    } else if (codeDetails.used === false) {
                        isCodeLoggedIn = true;
                    }
                } else {
                    isCodeLoggedIn = false;
                    localStorage.removeItem('userAccessCode');
                    showToast('تم إلغاء تفعيل الكود، يرجى التواصل مع المدرس.', 'error');
                    navigate('home');
                    renderTeachers(allTeachers);
                }
            })
            .catch(error => {
                console.error('فشل في التحقق الدوري من حالة الاشتراك:', error);
            });
    }

    // وظيفة تهيئة الثيم (بقي كما هو في الملف الأصلي)
    function initializeTheme() {
        // ... (منطق الثيم) ...
    }
    
    // منع النقر بالزر الأيمن والتحديد
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());

    // *** منطق تهيئة التطبيق (إلغاء شاشة الترحيب والدخول المباشر) ***
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      
      // إخفاء النوافذ المنبثقة الابتدائية وإظهار محتوى التطبيق مباشرة
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('pledgeModal').style.display = 'none'; 
      
      document.getElementById('appContent').style.display = 'block'; 
      document.getElementById('floatingContactBtn').style.display = 'flex'; 
      document.body.style.overflow = 'auto';

      // توليد وحفظ معرف الجهاز إذا لم يكن موجوداً
      if (!localStorage.getItem('deviceIdentifier')) {
          localStorage.setItem('deviceIdentifier', generateUUID());
      }

      // تحميل البيانات ومحاولة الدخول التلقائي
      loadData().then(() => {
          loadAccessCodes().then(() => {
              checkAutoLogin(); 
              navigate('home');
          });
      });
    });
    // نهاية التهيئة
  </script>
 </body>
</html>
